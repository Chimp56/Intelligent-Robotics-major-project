<launch>
    
    <!-- General args -->
    <arg name="gui"        default="true"/>

    <!-- Use your own world if you have one; falls back to empty world -->
    <arg name="world_file" default="$(find tour_guide)/world/sec2.world"/>

    <!-- Gazebo world  -->
    <include file="$(find gazebo_ros)/launch/empty_world.launch">
        <arg name="use_sim_time" value="true"/>
        <arg name="debug" value="false"/>
        <arg name="gui" value="$(arg gui)"/>
        <arg name="world_name" value="$(arg world_file)"/>
    </include>
    
    <!-- Robot flavor from your include folder -->
    <arg name="base"       value="$(optenv TURTLEBOT_BASE kobuki)"/>     <!-- create | roomba | kobuki -->
    <arg name="stacks"     value="$(optenv TURTLEBOT_STACKS hexagons)"/> <!-- circles | hexagons -->
    <arg name="3d_sensor"  value="$(optenv TURTLEBOT_3D_SENSOR kinect)"/> <!-- kinect | asus_xtion_pro -->

    <!--  Spawn TurtleBot via YOUR include (tour_guide) 
        Your includes expect x/y/z in meters and yaw in radians. -->

        <!-- Initial pose (in feet / degrees to match your earlier workflow) -->
    <arg name="x_feet" default="1.0"/>
    <arg name="y_feet" default="1.0"/>
    <arg name="z"      default="0.0"/>
    <arg name="yaw_deg" default="0.0"/>
    
    <include file="$(find tour_guide)/launch/includes/$(arg base).launch.xml">
        <arg name="base" value="$(arg base)"/>
        <arg name="stacks" value="$(arg stacks)"/>
        <arg name="3d_sensor" value="$(arg 3d_sensor)"/>

        <!-- feet/deg -> meters/radians -->
        <arg name="x"   value="$(eval arg('x_feet') / 3.28084)"/>
        <arg name="y"   value="$(eval arg('y_feet') / 3.28084)"/>
        <arg name="z"   value="$(arg z)"/>
        <arg name="yaw" value="$(eval arg('yaw_deg') * 3.14159265359 / 180.0)"/>
    </include>

    <!-- Fake laser from depth  -->
    <node pkg="nodelet" type="nodelet" name="laserscan_nodelet_manager" args="manager"/>
    <node pkg="nodelet" type="nodelet" name="depthimage_to_laserscan"
            args="load depthimage_to_laserscan/DepthImageToLaserScanNodelet laserscan_nodelet_manager">
        <param name="scan_height" value="10"/>
        <param name="output_frame_id" value="camera_depth_frame"/>
        <param name="range_min" value="0.0"/>
        <remap from="image" to="/camera/depth/image_raw"/>
        <remap from="scan"  to="/scan"/>
    </node>

    <!--  GMapping SLAM (inline; no external include needed)-->
    <node pkg="gmapping" type="slam_gmapping" name="slam_gmapping" output="screen">
        <param name="base_frame" value="base_link"/>
        <param name="odom_frame" value="odom"/>
        <param name="map_update_interval" value="2.0"/>

        <!-- Tune these for your room size -->
        <param name="maxUrange" value="5.0"/>
        <param name="maxRange"  value="8.0"/>
        <param name="minimumScore" value="50"/>
        <param name="delta" value="0.05"/>  <!-- map resolution (m/cell) -->

        <remap from="scan" to="/scan"/>
    </node>
    
    <!-- controller will start required nodes -->
    <include file="$(find tour_guide)/launch/controller.launch" />
</launch>